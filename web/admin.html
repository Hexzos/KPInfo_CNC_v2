<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPInfo CNC - Administración</title>

  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/modal-pedido.css" />
  <link rel="stylesheet" href="/assets/css/admin.css" />
  <link rel="icon" href="/favicon.ico">
  

</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar__brand">
        <div class="sidebar__title">KPInfo</div>

        <div id="sidebarMeta" class="sidebar__meta" hidden>
          <div id="sidebarMetaName" class="sidebar__meta-name"></div>
          <div id="sidebarMetaDate" class="sidebar__meta-date"></div>
        </div>
      </div>

      <nav class="sidebar__nav" aria-label="Navegación">
        <!-- solo admin (core.js lo muestra/oculta) -->
        <a id="navAdmin" class="navlink" href="/admin.html" hidden>Administración</a>
        <a class="navlink" href="/pedidos.html">Pedidos</a>
        <a class="navlink" href="/anomalias.html">Anomalías</a>
        <a class="navlink" href="/exportar.html">Exportar datos</a>

      </nav>

      <div class="sidebar__footer">
        <button id="btnSalir" class="btn btn--light">Salir del registro</button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar__left">
          <button id="btnMenu" class="topbar__burger" type="button" aria-label="Abrir menú">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <h1 class="page-title">Administración</h1>
        </div>

        <button id="btnExtras" class="iconbtn" title="Opciones extras" aria-label="Opciones extras">
            <svg class="icon-extras" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.1 7.1 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.42l-.36 2.54c-.58.23-1.12.54-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 7.48a.5.5 0 0 0 .12.64L4.85 9.7c-.04.31-.06.63-.06.94s.02.63.06.94L2.82 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.23.4.32.64.22l2.39-.96c.5.4 1.05.72 1.63.94l.36 2.54c.04.24.25.42.49.42h3.8c.24 0 .45-.18.49-.42l.36-2.54c.58-.23 1.12-.54 1.63-.94l2.39.96c.24.1.51.01.64-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z"/>
            </svg>
          </button>

      </header>

      <section class="content">

          <div class="admin-panels">
            <!-- Estado -->
            <section id="sec-estado" class="card admin-card">
              <div class="admin-card__head">
                <div>
                  <div class="admin-card__title">Estado administrativo</div>
                  <div class="muted admin-card__sub">
                    Vista disponible solo para rol <b>admin</b>. Algunas acciones requieren Opciones Extras activas.
                  </div>
                </div>
                <div id="adminBadge" class="estado-pill">—</div>
              </div>
              <div id="adminMsg" class="msg"></div>
            </section>

            <!-- Acciones críticas -->
            <section id="sec-criticas" class="card admin-card">
              <div class="admin-card__head">
                <div>
                  <div class="admin-card__title">Acciones críticas</div>
                  <div class="muted admin-card__sub">
                    Purga por rango o purga completa por entidad. Requiere Opciones Extras activas.
                  </div>
                </div>
              </div>

              <div class="admin-actions">
                <button id="btnOpenPurgePedidos" class="btn btn--light" type="button">Eliminar pedidos archivados</button>
                <button id="btnOpenPurgeAnomalias" class="btn btn--light" type="button">Eliminar anomalías archivadas</button>
              </div>

              <div id="purgeMsg" class="msg"></div>
            </section>

            <!-- Clave operadores -->
            <section id="sec-extraskey" class="card admin-card">
              <div class="admin-card__head">
                <div>
                  <div class="admin-card__title">Clave de acceso de opciones extras</div>
                  <div class="muted admin-card__sub">
                    Se validará la clave actual y luego se actualizará por una nueva (mín. 8 caracteres).
                  </div>
                </div>
              </div>

              <div class="admin-actions">
                <button id="btnOpenRotateExtrasKey" class="btn btn--primary" type="button">Cambiar clave</button>
              </div>

              <div id="extrasKeyMsg" class="msg"></div>
            </section>

            <!-- Usuarios (CRUD) -->
            <section id="sec-usuarios" class="card admin-card">
              <div class="admin-card__head">
                <div>
                  <div class="admin-card__title">Usuarios</div>
                  <div class="muted admin-card__sub">
                    Gestión de operadores y administradores. No es posible deshabilitar al último administrador activo.
                  </div>
                </div>

                <div class="admin-card__head-actions">
                  <button id="btnOpenUsuarioNuevo" class="btn btn--primary" type="button">Nuevo usuario</button>
                </div>
              </div>

              <!-- Filtros -->
              <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr)); margin-top: 8px;">
                <div class="field">
                  <label for="usrQ">Buscar</label>
                  <input id="usrQ" type="text" placeholder="Nombre, apellido, email o username" />
                  <div class="help muted">Tip: presiona Enter para buscar.</div>
                </div>

                <div class="field">
                  <label for="usrRol">Rol</label>
                  <select id="usrRol">
                    <option value="">Todos</option>
                    <option value="admin">Admin</option>
                    <option value="operador">Operador</option>
                  </select>
                </div>

                <div class="field">
                  <label for="usrActivos">Estado</label>
                  <select id="usrActivos">
                    <option value="">Todos</option>
                    <option value="1">Activos</option>
                    <option value="0">Inactivos</option>
                  </select>
                </div>

                <div class="actions field--wide" style="justify-content:flex-start; gap:8px;">
                  <button id="btnUsrBuscar" class="btn btn--light" type="button">Aplicar filtros</button>
                  <button id="btnUsrLimpiar" class="btn btn--light" type="button">Limpiar</button>
                  <button id="btnUsrRefrescar" class="btn btn--light" type="button">Refrescar</button>
                </div>

                <div id="usuariosMsg" class="msg field--wide"></div>
              </div>

              <!-- Tabla -->
              <div class="admin-table-wrap" style="margin-top: 10px;">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th style="width: 30%;">Nombre</th>
                      <th style="width: 30%;">Email / Username</th>
                      <th style="width: 12%;">Rol</th>
                      <th style="width: 10%;">Activo</th>
                      <th style="width: 18%;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="usuariosTbody">
                    <tr><td colspan="5" class="muted">Sin datos.</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="muted" style="font-size:12px; margin-top: 8px;">
                Nota: por seguridad, un admin no puede deshabilitarse a sí mismo. Además, el sistema no permite deshabilitar al último admin activo.
              </div>
            </section>



            <!-- Catálogos -->
            <section id="sec-catalogos" class="card admin-card">
              <div class="admin-card__head">
                <div>
                  <div class="admin-card__title">Catálogos</div>
                  <div class="muted admin-card__sub">
                    Acceso rápido a tipos de plancha (Materiales), variaciones, turnos y máquinas.
                  </div>
                </div>
              </div>

              <!-- Filtro de Catálogos -->
              <div class="form-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr)); margin-top: 10px;">
                <div class="field">
                  <label for="catFiltro">Ver catálogo</label>
                  <select id="catFiltro">
                    <option value="all">Todos</option>
                    <option value="materiales">Materiales (Tipos de plancha)</option>
                    <option value="variaciones">Variaciones</option>
                    <option value="turnos">Turnos</option>
                    <option value="maquinas">Máquinas</option>
                  </select>
                  <div class="help muted">Sugerencia: selecciona un tipo para evitar ver todos los ítems a la vez.</div>
                </div>
              </div>


              <div class="admin-grid2">
                <div class="admin-catbox" data-catbox="materiales">
                  <div class="admin-minihead">
                    <div class="admin-minihead__title">Materiales (Tipos de plancha)</div>
                    <div class="admin-minihead__actions">
                      <button class="btn btn--light btn--xs" type="button" disabled>Nuevo</button>
                      <button class="btn btn--light btn--xs" type="button" disabled>Actualizar</button>
                    </div>
                  </div>
                  <div class="admin-table-wrap">
                    <table class="admin-table">
                      <thead>
                        <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                        </tr>
                    </thead>
                      <tbody id="materialesTbody"><tr><td colspan="4" class="muted">Sin datos.</td></tr></tbody>
                    </table>
                  </div>
                </div>

                <div class="admin-catbox" data-catbox="variaciones">
                  <div class="admin-minihead">
                    <div class="admin-minihead__title">Variaciones</div>
                    <div class="admin-minihead__actions">
                      <button class="btn btn--light btn--xs" type="button" disabled>Nueva</button>
                      <button class="btn btn--light btn--xs" type="button" disabled>Actualizar</button>
                    </div>
                  </div>

                  <div class="admin-table-wrap">
                    <table class="admin-table">
                      <thead><tr><th>ID</th><th>Nombre</th><th>Activo</th><th>Acciones</th></tr></thead>
                      <tbody id="variacionesTbody"><tr><td colspan="4" class="muted">Sin datos.</td></tr></tbody>
                    </table>
                  </div>

                  <div id="varAssignMount"></div>
                </div>

                <div class="admin-catbox" data-catbox="turnos">
                  <div class="admin-minihead">
                    <div class="admin-minihead__title">Turnos</div>
                    <div class="admin-minihead__actions">
                      <button class="btn btn--light btn--xs" type="button" disabled>Nuevo</button>
                      <button class="btn btn--light btn--xs" type="button" disabled>Actualizar</button>
                    </div>
                  </div>
                  <div class="admin-table-wrap">
                    <table class="admin-table">
                      <thead><tr><th>ID</th><th>Nombre</th><th>Activo</th><th>Acciones</th></tr></thead>
                      <tbody id="turnosTbody"><tr><td colspan="4" class="muted">Sin datos.</td></tr></tbody>
                    </table>
                  </div>
                </div>

                <div class="admin-catbox" data-catbox="maquinas">
                  <div class="admin-minihead">
                    <div class="admin-minihead__title">Máquinas</div>
                    <div class="admin-minihead__actions">
                      <button class="btn btn--light btn--xs" type="button" disabled>Nueva</button>
                      <button class="btn btn--light btn--xs" type="button" disabled>Actualizar</button>
                    </div>
                  </div>
                  <div class="admin-table-wrap">
                    <table class="admin-table">
                      <thead><tr><th>ID</th><th>Nombre</th><th>Activo</th><th>Acciones</th></tr></thead>
                      <tbody id="maquinasTbody"><tr><td colspan="4" class="muted">Sin datos.</td></tr></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div id="catalogosMsg" class="msg"></div>
            </section>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Overlay ÚNICO -->
  <div id="overlay" class="overlay" hidden></div>

  
  <div id="menuOverlay" class="menu-overlay" hidden></div>
<!-- MODAL: Purga Pedidos -->
    <section id="modalPurgePedidos" class="modal" role="dialog" aria-modal="true"
            aria-labelledby="modalPurgePedidosTitle" hidden>
    <div class="modal__card">
        <header class="modal__header">
        <h2 id="modalPurgePedidosTitle">Eliminar pedidos archivados</h2>
        <button class="iconbtn iconbtn--flat" data-close="modalPurgePedidos" aria-label="Cerrar">✖</button>
        </header>

        <div class="form-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
        <div class="field">
            <label for="purgePedidosDesde">Desde</label>
            <input id="purgePedidosDesde" type="date" />
            <div class="help" data-err="purge_pedidos_desde"></div>
        </div>

        <div class="field">
            <label for="purgePedidosHasta">Hasta</label>
            <input id="purgePedidosHasta" type="date" />
            <div class="help" data-err="purge_pedidos_hasta"></div>
        </div>

        <div id="purgePedidosMsg" class="msg field--wide"></div>

        <div class="actions field--wide">
            <button id="btnDoPurgePedidosRange" class="btn btn--primary" type="button">Eliminar por rango</button>
            <button id="btnDoPurgePedidosAll" class="btn btn--light" type="button">Purga completa (Pedidos)</button>
        </div>

        <div class="muted field--wide" style="font-size:12px;">
            Purga completa eliminará definitivamente todos los pedidos con estado archivado.
        </div>
        </div>
    </div>
    </section>


  <!-- MODAL: Purga Anomalías -->
    <section id="modalPurgeAnomalias" class="modal" role="dialog" aria-modal="true"
            aria-labelledby="modalPurgeAnomaliasTitle" hidden>
    <div class="modal__card">
        <header class="modal__header">
        <h2 id="modalPurgeAnomaliasTitle">Eliminar anomalías archivadas</h2>
        <button class="iconbtn iconbtn--flat" data-close="modalPurgeAnomalias" aria-label="Cerrar">✖</button>
        </header>

        <div class="form-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
        <div class="field">
            <label for="purgeAnomaliasDesde">Desde</label>
            <input id="purgeAnomaliasDesde" type="date" />
            <div class="help" data-err="purge_anomalias_desde"></div>
        </div>

        <div class="field">
            <label for="purgeAnomaliasHasta">Hasta</label>
            <input id="purgeAnomaliasHasta" type="date" />
            <div class="help" data-err="purge_anomalias_hasta"></div>
        </div>

        <div id="purgeAnomaliasMsg" class="msg field--wide"></div>

        <div class="actions field--wide">
            <button id="btnDoPurgeAnomaliasRange" class="btn btn--primary" type="button">Eliminar por rango</button>
            <button id="btnDoPurgeAnomaliasAll" class="btn btn--light" type="button">Purga completa (Anomalías)</button>
        </div>

        <div class="muted field--wide" style="font-size:12px;">
            Purga completa eliminará definitivamente todas las anomalías archivadas.
        </div>
        </div>
    </div>
    </section>


  <!-- MODAL: Rotar clave -->
    <section id="modalRotateExtrasKey" class="modal" role="dialog" aria-modal="true"
            aria-labelledby="modalRotateExtrasKeyTitle" hidden>
    <div class="modal__card">
        <header class="modal__header">
        <h2 id="modalRotateExtrasKeyTitle">Cambiar clave de acceso de opciones extras</h2>
        <button class="iconbtn iconbtn--flat" data-close="modalRotateExtrasKey" aria-label="Cerrar">✖</button>
        </header>

        <div class="form-grid">
        <div class="field">
            <label for="extrasKeyCurrent">Clave actual *</label>
            <input id="extrasKeyCurrent" type="password" autocomplete="current-password" />
            <div class="help" data-err="extras_key_current"></div>
        </div>

        <div class="field">
            <label for="extrasKeyNewModal">Nueva clave (mín. 8) *</label>
            <input id="extrasKeyNewModal" type="password" autocomplete="new-password" />
            <div class="help" data-err="extras_key_new"></div>
        </div>

        <div class="field">
            <label for="extrasKeyNewConfirm">Confirmar nueva clave *</label>
            <input id="extrasKeyNewConfirm" type="password" autocomplete="new-password" />
            <div class="help" data-err="extras_key_confirm"></div>
        </div>

        <div id="rotateExtrasKeyMsg" class="msg field--wide"></div>

        <div class="actions field--wide">
            <button id="btnDoRotateExtrasKey" class="btn btn--primary" type="button">Actualizar clave</button>
        </div>
        </div>
    </div>
    </section>

    <!-- MODAL: Usuario (crear/editar reutilizable) -->
    <section id="modalUsuario" class="modal" role="dialog" aria-modal="true"
            aria-labelledby="modalUsuarioTitle" hidden>
      <div class="modal__card">
        <header class="modal__header">
          <h2 id="modalUsuarioTitle">Usuario</h2>
          <button class="iconbtn iconbtn--flat" data-close="modalUsuario" aria-label="Cerrar">✖</button>
        </header>

        <!-- hidden: id del usuario en modo edición -->
        <input id="usrId" type="hidden" />

        <div class="form-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
          <div class="field">
            <label for="usrNombre">Nombre *</label>
            <input id="usrNombre" type="text" />
            <div class="help" data-err="usr_nombre"></div>
          </div>

          <div class="field">
            <label for="usrApellido">Apellido *</label>
            <input id="usrApellido" type="text" />
            <div class="help" data-err="usr_apellido"></div>
          </div>

          <div class="field">
            <label for="usrEmail">Email *</label>
            <input id="usrEmail" type="email" autocomplete="email" />
            <div class="help" data-err="usr_email"></div>
          </div>

          <div class="field">
            <label for="usrUsername">Username (opcional)</label>
            <input id="usrUsername" type="text" autocomplete="username" />
            <div class="help" data-err="usr_username"></div>
          </div>

          <div class="field">
            <label for="usrRolModal">Rol *</label>
            <select id="usrRolModal">
              <option value="operador">Operador</option>
              <option value="admin">Admin</option>
            </select>
            <div class="help" data-err="usr_rol"></div>
          </div>

          <div class="field">
            <label for="usrActivo">Estado *</label>
            <select id="usrActivo">
              <option value="1">Activo</option>
              <option value="0">Inactivo</option>
            </select>
            <div class="help" data-err="usr_activo"></div>
          </div>

          

          <!-- Password SOLO en crear: se ocultará en modo edición -->
          <div id="usrPasswordWrap" class="field field--wide">
            <label for="usrPassword">Password * (mín. 8)</label>
            <input id="usrPassword" type="password" autocomplete="new-password" />
            <div class="help" data-err="usr_password"></div>
          </div>

          <!-- Bloque: Cambio de contraseña (Variante 2) - SOLO edición -->
          <section id="pwdChangeBox" class="card" style="margin-top:10px;" hidden>
            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
              <div>
                <div style="font-weight:700;">Cambio de contraseña (solicitudes)</div>
                <div class="muted" style="font-size:12px;">
                  En caso de que el operador solicite cambio de contraseña. Aquí puedes ver estado e historial, y aprobar/cancelar.
                </div>
              </div>

              <button id="btnPwdRefresh" class="btn btn--light btn--xs" type="button">Refrescar</button>
            </div>

            <div id="pwdChangeMsg" class="msg" style="margin-top:8px;"></div>

            <!-- Activa -->
            <div id="pwdActiveWrap" style="margin-top:8px;" hidden>
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <span class="estado-pill">PENDING</span>
                <span class="muted" style="font-size:12px;">
                  Creado: <span id="pwdActiveCreado">—</span> · Expira: <span id="pwdActiveExpira">—</span> · IP: <span id="pwdActiveIP">—</span>
                </span>
              </div>

              <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                <button id="btnPwdApprove" class="btn btn--primary btn--xs" type="button">Aprobar y aplicar</button>
                <button id="btnPwdCancel" class="btn btn--light btn--xs" type="button">Cancelar solicitud</button>
              </div>
            </div>

            <!-- Historial -->
            <div style="margin-top:10px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Historial (últimas 5)</div>
              <div class="admin-table-wrap">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th style="width:18%;">Estado</th>
                      <th style="width:28%;">Creado</th>
                      <th style="width:28%;">Resuelto</th>
                      <th style="width:26%;">Resuelto por</th>
                    </tr>
                  </thead>
                  <tbody id="pwdHistoryTbody">
                    <tr><td colspan="4" class="muted">Sin datos.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>


          <div id="usuarioModalMsg" class="msg field--wide"></div>

          <div class="actions field--wide">
            <button id="btnUsrGuardar" class="btn btn--primary" type="button">Guardar</button>
            <button class="btn btn--light" type="button" data-close="modalUsuario">Cancelar</button>
          </div>

        </div>
      </div>
    </section>



    <script src="/assets/js/core.js"></script>
    <script src="/assets/js/nav.js"></script>
<script src="/assets/js/extras.js"></script>
    <script src="/assets/js/cierre_modal.js"></script>

   
    <script src="/assets/js/admin/catalogos.modal.js"></script>

   
    <script src="/assets/js/admin/admin.state.js"></script>
    <script src="/assets/js/admin/admin.ui.js"></script>
    <script src="/assets/js/admin/admin.extras.js"></script>
    <script src="/assets/js/admin/admin.catalogos.js"></script>
    <script src="/assets/js/admin/admin.usuarios.js"></script>
    <script src="/assets/js/admin/admin.page.js"></script>


  <script>
  
    window.KPINIT && window.KPINIT.guard && window.KPINIT.guard();
    window.KPINIT && window.KPINIT.requireAdminPage && window.KPINIT.requireAdminPage();
    window.KPINIT && window.KPINIT.initNavActive && window.KPINIT.initNavActive();
    window.KPINIT && window.KPINIT.initSidebarMeta && window.KPINIT.initSidebarMeta();
    window.KP && window.KP.nav && window.KP.nav.initAll && window.KP.nav.initAll();
    window.KPINIT && window.KPINIT.initExtras && window.KPINIT.initExtras();

    window.KP && window.KP.cierre && window.KP.cierre.initAll && window.KP.cierre.initAll();

    window.KP && window.KP.admin && window.KP.admin.page && window.KP.admin.page.initAll && window.KP.admin.page.initAll();
  </script>
</body>
</html>
