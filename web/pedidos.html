<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPInfo CNC - Pedidos</title>

  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/modal-pedido.css" />
  <link rel="stylesheet" href="/assets/css/modal-detalle.css" />
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar__brand">
        <div class="sidebar__title">KPInfo</div>

        <div id="sidebarMeta" class="sidebar__meta" hidden>
          <div id="sidebarMetaName" class="sidebar__meta-name"></div>
          <div id="sidebarMetaDate" class="sidebar__meta-date"></div>
        </div>
      </div>

      <nav class="sidebar__nav" aria-label="Navegación">
        <a id="navAdmin" class="navlink" href="/admin.html" hidden>Administración</a>
        <a class="navlink" href="/pedidos.html">Pedidos</a>
        <a class="navlink" href="/anomalias.html">Anomalías</a>
        <a class="navlink" href="/exportar.html">Exportar datos</a>
      </nav>

      <div class="sidebar__footer">
        <button id="btnSalir" class="btn btn--light">Salir del registro</button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar__left">
          <button id="btnMenu" class="topbar__burger" type="button" aria-label="Abrir menú">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <h1 class="page-title">Pedidos</h1>
        </div>

        <div class="topbar__right">
          <div class="admin-lista">
            <label for="listaSel">Lista</label>
            <select id="listaSel">
              <option value="general">General</option>
              <option value="en_proceso">En proceso</option>
              <option value="completado">Completados</option>
              <option value="cancelado">Cancelados</option>

              <!-- ✅ No se crea por JS. Se muestra/oculta según KP.Session.isAdminEnabled() -->
              <option value="archivado" hidden>Archivados</option>
            </select>
          </div>

          <button id="btnExtras" class="iconbtn" title="Opciones extras" aria-label="Opciones extras">
            <svg class="icon-extras" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.1 7.1 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.42l-.36 2.54c-.58.23-1.12.54-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 7.48a.5.5 0 0 0 .12.64L4.85 9.7c-.04.31-.06.63-.06.94s.02.63.06.94L2.82 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.23.4.32.64.22l2.39-.96c.5.4 1.05.72 1.63.94l.36 2.54c.04.24.25.42.49.42h3.8c.24 0 .45-.18.49-.42l.36-2.54c.58-.23 1.12-.54 1.63-.94l2.39.96c.24.1.51.01.64-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z"/>
            </svg>
          </button>


        </div>
      </header>

      <section class="content">
        <div class="searchbar">
          <input id="q" type="search" placeholder="Buscar por código, descripción o fecha" />
        </div>

        <div id="emptyState" class="empty">
          No hay pedidos pendientes, ingrese uno para continuar.
        </div>

        <div id="cards" class="cards" hidden></div>

        <template id="pedidoTpl">
          <article class="pedido-card" data-id="">
            <div class="pedido-card__grid">
              <div class="pedido-col">
                <div class="pedido-code" data-code></div>
                <div class="pedido-desc" data-desc></div>
              </div>

              <div class="pedido-col">
                <div class="pedido-label">Registrado en</div>
                <div class="pedido-val" data-turno></div>
                <div class="pedido-val" data-fecha></div>
              </div>

              <div class="pedido-col">
                <div class="pedido-label">Máquina asignada</div>
                <div class="pedido-val" data-maquina></div>
              </div>

              <div class="pedido-col pedido-col--estado">
                <div class="pedido-label">Estado</div>
                <div class="estado-pill" data-estado></div>
              </div>
            </div>
          </article>
        </template>
      </section>

      <button id="fabCrear" class="fab" aria-label="Crear pedido" title="Crear pedido">+</button>
    </main>
  </div>

  <div id="overlay" class="overlay" hidden></div>

  
  <div id="menuOverlay" class="menu-overlay" hidden></div>
<!-- Modal Crear -->
  <section id="modalPedido" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalPedidoTitle" hidden>
    <div class="modal__card">
      <header class="modal__header">
        <h2 id="modalPedidoTitle">Nuevo pedido</h2>
        <button id="btnCerrarModalPedido" class="iconbtn iconbtn--flat" aria-label="Cerrar">✖</button>
      </header>

      <form id="formPedido" class="form-grid" novalidate>
        <div class="field">
          <label>Fecha</label>
          <div id="pedidoFecha" class="readonly">—</div>
        </div>

        <div class="field field--center">
          <label for="turnoSel">Turno *</label>
          <select id="turnoSel" required>
            <option value="" selected disabled>Seleccione un turno</option>
          </select>
          <div class="help" data-err="turno_id"></div>
        </div>

        <div class="field">
          <label for="maquinaAsignadaSel">Máquina asignada *</label>
          <select id="maquinaAsignadaSel" required>
            <option value="" selected disabled>Seleccione la máquina CNC</option>
            <option value="BOF">BOF</option>
            <option value="Rover">Rover</option>
            <option value="Ambas">Ambas</option>
          </select>
          <div class="help" data-err="maquina_asignada"></div>
        </div>

        <div class="field">
          <label for="codigoProducto">Código del producto *</label>
          <input id="codigoProducto" type="text" placeholder="Ingrese el código a mecanizar" required />
          <div class="help" data-err="codigo_producto"></div>
        </div>

        <div class="field field--textarea">
          <label for="descripcionProducto">Descripción *</label>
          <textarea id="descripcionProducto" rows="4"
            placeholder="Describe el trabajo a realizar, tipo de corte o contexto relevante"
            required></textarea>
          <div class="help" data-err="descripcion_producto"></div>
        </div>

        <div class="section-label field--wide">Material</div>

        <div class="field">
          <label for="tipoPlanchaSel">Tipo *</label>
          <select id="tipoPlanchaSel" required>
            <option value="" disabled selected>Seleccione el tipo de plancha</option>
          </select>
          <div class="help" data-err="tipo_plancha_id"></div>
        </div>

        <div class="field field--center">
          <label for="espesorMm">Espesor (mm) *</label>
          <input id="espesorMm" type="number" min="0" step="0.1" placeholder="Espesor de la plancha" required />
          <div class="help" data-err="espesor_mm"></div>
        </div>

        <div class="field">
          <label for="medidaPlancha">Medida *</label>
          <input id="medidaPlancha" type="text" placeholder="Medida de la plancha (ej: 1220x2440)" required />
          <div class="help" data-err="medida_plancha"></div>
        </div>

        <div class="field">
          <label for="variacionSel">Variación *</label>
          <select id="variacionSel" required>
            <option value="" disabled selected>Seleccionar propiedades extra</option>
          </select>
          <div class="help" data-err="variacion_material"></div>
        </div>

        <div class="section-label field--wide">Producción</div>

        <div class="field">
          <label for="planchasAsignadas">Cantidad de planchas asignadas *</label>
          <input id="planchasAsignadas" type="number" min="1" step="1"
            placeholder="Ingrese el total de planchas a mecanizar" required />
          <div class="help" data-err="planchas_asignadas"></div>
        </div>

        <div class="actions field--wide">
          <button id="btnGenerarPedido" type="submit" class="btn btn--primary">Generar pedido</button>
          <div id="pedidoMsg" class="msg"></div>
        </div>
      </form>
    </div>
  </section>

  <!-- Modal Detalle -->
  <section id="modalPedidoDetalle" class="modal modal-detalle" role="dialog" aria-modal="true" aria-labelledby="modalDetalleTitle" hidden>
    <div class="modal__card modal-detalle__card">
      <header class="modal-detalle__header">
        <div>
          <h2 id="modalDetalleTitle" class="modal-detalle__title">
            Pedido&nbsp;<span data-det="codigo_producto"></span>
          </h2>
          <div class="modal-detalle__subtitle" data-det="descripcion_producto"></div>
        </div>
        <button id="btnCerrarModalDetalle" class="iconbtn iconbtn--close" aria-label="Cerrar">✖</button>
      </header>

      <div class="modal-detalle__grid">
        <div class="det-block">
          <div class="det-label">Iniciado en</div>
          <div class="det-val" data-det="turno_nombre"></div>
          <div class="det-val" data-det="fecha_registro"></div>
        </div>

        <div class="det-block">
          <div class="det-label">Material</div>
          <div class="det-val" data-det="tipo_plancha_nombre"></div>
        </div>

        <div class="det-block">
          <div class="det-label">Espesor</div>
          <div class="det-val"><span data-det="espesor_mm"></span> mm</div>
        </div>

        <div class="det-block">
          <div class="det-label">Variación</div>
          <div class="det-val" data-det="variacion_material"></div>
        </div>

        <div class="det-block">
          <div class="det-label">Máquina asignada</div>
          <div class="det-val" data-det="maquina_asignada"></div>
        </div>

        <div class="det-block">
          <div class="det-label">Planchas asignadas</div>
          <div class="det-val" data-det="planchas_asignadas"></div>
        </div>

        <div class="det-block">
          <div class="det-label">Última plancha trabajada</div>

          <div id="roUltimaPlancha" class="det-val" data-ro="ultima_plancha_trabajada">—</div>

          <input
            id="detUltimaPlancha"
            class="det-input"
            type="number"
            min="0"
            step="1"
            disabled
            hidden
          />

          <button id="btnModUltima" class="btn btn--light btn--xs" type="button">Modificar</button>
        </div>

        <div class="det-block">
          <div class="det-label">Cortes totales alcanzados</div>

          <div id="roCortesTotales" class="det-val" data-ro="cortes_totales">—</div>

          <input
            id="detCortesTotales"
            class="det-input"
            type="number"
            min="0"
            step="1"
            disabled
            hidden
          />

          <button id="btnSumarCorte" class="btn btn--light btn--xs" type="button">Añadir corte</button>
        </div>
      </div>

      <div class="modal-detalle__estado">
        <div class="det-label">Estado</div>

        <div class="estado-row">
          <div id="roEstado" class="det-val estado-pill" data-ro="estado">—</div>

          <select id="detEstado" class="det-select" disabled hidden>
            <option value="en_proceso">En proceso</option>
            <option value="completado">Completado</option>
            <option value="cancelado">Cancelado</option>
          </select>

          <button id="btnModEstado" class="btn btn--light btn--xs" type="button">Modificar</button>
        </div>
      </div>

      <div class="modal-detalle__footer">
        <div id="detalleMsg" class="msg"></div>

        <!-- ✅ Admin actions (solo UI; JS decide visible) -->
        <button id="btnArchivarPedido" class="btn btn--light" type="button" hidden>Archivar</button>
        <button id="btnRestaurarPedido" class="btn btn--light" type="button" hidden>Restaurar</button>

        <button id="btnGuardarDetalle" class="btn btn--primary" type="button" disabled>Guardar</button>
      </div>
    </div>
  </section>

  <script src="/assets/js/core.js"></script>
  <script src="/assets/js/nav.js"></script>
<script src="/assets/js/extras.js"></script>
  <script src="/assets/js/cierre_modal.js"></script>
  <script src="/assets/js/pedidos.list.js"></script>
  <script src="/assets/js/pedidos.modal.crear.js"></script>
  <script src="/assets/js/pedidos.modal.detalle.js"></script>
  <script src="/assets/js/pedidos.js"></script>

  <script>
    window.KPINIT && window.KPINIT.guard && window.KPINIT.guard();
    window.KPINIT && window.KPINIT.initNavActive && window.KPINIT.initNavActive();
    window.KPINIT && window.KPINIT.initSidebarMeta && window.KPINIT.initSidebarMeta();
    window.KP && window.KP.nav && window.KP.nav.initAll && window.KP.nav.initAll();
    window.KP && window.KP.extras && window.KP.extras.initAll && window.KP.extras.initAll();
    window.KP && window.KP.cierre && window.KP.cierre.initAll && window.KP.cierre.initAll();
    window.KP && window.KP.pedidos && window.KP.pedidos.initAll && window.KP.pedidos.initAll();
  </script>

</body>
</html>
